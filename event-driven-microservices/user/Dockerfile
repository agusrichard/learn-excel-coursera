## Build stage
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
COPY . .

ARG DB_USERNAME
ARG DB_PASSWORD
ARG DB_NAME
ARG DB_HOST
ARG PORT
ARG SECRET_KEY
ARG AMQP_URL
ARG AUTH_TO_USER_QUEUE
ARG USER_TO_AUTH_QUEUE

ENV DB_USERNAME $DB_USERNAME
ENV DB_PASSWORD $DB_PASSWORD
ENV DB_NAME $DB_NAME
ENV DB_HOST $DB_HOST
ENV PORT $PORT
ENV SECRET_KEY $SECRET_KEY
ENV AMQP_URL $AMQP_URL
ENV AUTH_TO_USER_QUEUE $AUTH_TO_USER_QUEUE
ENV USER_TO_AUTH_QUEUE $USER_TO_AUTH_QUEUE

RUN npm install
RUN npm run build

## Run stage
FROM node:16-alpine

WORKDIR /app
COPY package*.json ./
RUN npm install --only=production
COPY --from=0 /app/build ./build
EXPOSE 3000
CMD npm start